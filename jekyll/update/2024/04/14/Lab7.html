<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Lab7 | Fast Robots 2024 Spring</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Lab7" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This website displays the content in the course Fast Robots (Cornell ECE 5160 Spring 2024)." />
<meta property="og:description" content="This website displays the content in the course Fast Robots (Cornell ECE 5160 Spring 2024)." />
<link rel="canonical" href="http://localhost:4000/FastRobots/jekyll/update/2024/04/14/Lab7.html" />
<meta property="og:url" content="http://localhost:4000/FastRobots/jekyll/update/2024/04/14/Lab7.html" />
<meta property="og:site_name" content="Fast Robots 2024 Spring" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-04-14T00:00:00-04:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Lab7" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-04-14T00:00:00-04:00","datePublished":"2024-04-14T00:00:00-04:00","description":"This website displays the content in the course Fast Robots (Cornell ECE 5160 Spring 2024).","headline":"Lab7","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/FastRobots/jekyll/update/2024/04/14/Lab7.html"},"url":"http://localhost:4000/FastRobots/jekyll/update/2024/04/14/Lab7.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/FastRobots/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/FastRobots/feed.xml" title="Fast Robots 2024 Spring" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/FastRobots/">Fast Robots 2024 Spring</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/FastRobots/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Lab7</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-04-14T00:00:00-04:00" itemprop="datePublished">Apr 14, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config({
      TeX: {
        equationNumbers: {
          autoNumber: "AMS"
        }
      },
      extensions: ["tex2jax.js"],
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true,
      "HTML-CSS": { fonts: ["TeX"] }
    }
  });
  MathJax.Hub.Register.MessageHook("Math Processing Error",function (message) {
        alert("Math Processing Error: "+message[1]);
      });
  MathJax.Hub.Register.MessageHook("TeX Jax - parse error",function (message) {
        alert("Math Processing Error: "+message[1]);
      });
</script>

<script type="text/javascript" async="" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<h2 id="1-estimate-drag-and-momentum">1. Estimate drag and momentum</h2>

<blockquote>
  <p>Choose your step responce, u(t), to be of similar size to the PWM value you used in Lab 6 (to keep the dynamics similar). Pick something between 50%-100% of the maximum u.</p>
</blockquote>

<p>I choose 80% of the maximum u, so the pwm value is 210 out of 255.</p>

<p>The step response of the car is shown in the following graph:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">()</span>

<span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">tab:red</span><span class="sh">'</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">set_xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Time (s)</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Distance</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">timestamps_s</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">ax1</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">.</span><span class="nf">twinx</span><span class="p">()</span>  
<span class="n">color</span> <span class="o">=</span> <span class="sh">'</span><span class="s">tab:blue</span><span class="sh">'</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">set_ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Left PWM</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>  
<span class="n">ax2</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">timestamps_s</span><span class="p">,</span> <span class="n">left_pwms</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
<span class="n">ax2</span><span class="p">.</span><span class="nf">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Distance and PWM vs. Time</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div>

<p><img src="/FastRobots/images/Lab7/step-distance-nointerp.jpeg" alt="step-distance-nointerp" style="zoom:40%;" /></p>

<p>Because the distance sensor is operated in a non-blocking way, there are significant steps in the distance measurements. It brings errors in the velocity calculation. To solve this problem, I use interpolatation tool in numpy to guess the distance data between new sensor reading values.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># find non accurate data points
</span><span class="n">to_delete_idxs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">curr_dist</span> <span class="o">=</span> <span class="n">distances</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">curr_dist</span> <span class="o">==</span> <span class="n">prev_dist</span><span class="p">:</span>
        <span class="n">to_delete_idxs</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">prev_dist</span> <span class="o">=</span> <span class="n">curr_dist</span>
        
<span class="c1"># interpolation
</span><span class="n">interpolated_distances</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">interp</span><span class="p">(</span><span class="n">timestamps_ms</span><span class="p">,</span> <span class="n">new_timestamps</span><span class="p">,</span> <span class="n">new_distances</span><span class="p">)</span>
</code></pre></div></div>

<p>The new graph is shown as follows:</p>

<p><img src="/FastRobots/images/Lab7/stepresponse-distance.jpeg" alt="stepresponse-distance" style="zoom:40%;" /></p>

<blockquote>
  <p>Make sure your step time is long enough to reach steady state (you likely have to use active breaking of the car to avoid crashing into the wall). Make sure to use a peice of foam to avoid hitting to wall and damaging your car.</p>
</blockquote>

<p>The graph above indicates that the speed of car has reached steady state after 1.0s.</p>

<blockquote>
  <p>Show graphs for the TOF sensor output, the (computed) speed, and the motor input. Please ensure that the x-axis is in seconds.</p>
</blockquote>

<p>I compute the speed based on interpolated distance data points, and use multupolynominal smoothing to make the curve of speed easier to analyze:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># calculate velocity based on distance
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">velocities</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">distances</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">distances</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">timestamps_ms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">timestamps_ms</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]))</span>
    
<span class="c1"># polynominal smoothing
</span><span class="n">smooth_velocities</span> <span class="o">=</span> <span class="nf">savgol_filter</span><span class="p">(</span><span class="n">velocities</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</code></pre></div></div>

<p>The graph looks like this:</p>

<p><img src="/FastRobots/images/Lab7/step-vel.jpg" alt="step-vel" style="zoom: 40%;" /></p>

<blockquote>
  <p>Measure the steady state speed, 90% rise time, and the speed at 90% risetime. (Note, this doesn’t have to be 90% rise time. You could also use somewhere between 60-90%, but the speed and time must correspond to get an accurate estimate for m.</p>
</blockquote>

<p><img src="/FastRobots/images/Lab7/step-velocity-calc.jpeg" alt="step-velocity-calc" style="zoom:40%;" /></p>

<p>steady state speed: 2.5 m/s = 2.5 mm/ms</p>

<p>90% rise time: 1.08 s = 1080 ms</p>

<blockquote>
  <p>When sending this data back to your laptop, make sure to save the data in a file so that you can use it even after your Jupyter kernal restarts. Consider writing the data to a <a href="https://docs.python.org/3/library/csv.html">CSV</a> file, <a href="https://docs.python.org/3/library/pickle.html">pickle file</a></p>
</blockquote>

<p>The data is saved to the output.csv file using the following code,</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="c1"># Create a DataFrame
</span><span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">'</span><span class="s">timestamp_ms</span><span class="sh">'</span><span class="p">:</span> <span class="n">timestamps_ms</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">distance</span><span class="sh">'</span><span class="p">:</span> <span class="n">distances</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">left_pwm</span><span class="sh">'</span><span class="p">:</span> <span class="n">left_pwms</span><span class="p">,</span>
    <span class="sh">'</span><span class="s">right_pwm</span><span class="sh">'</span><span class="p">:</span> <span class="n">right_pwms</span>
<span class="p">}</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="c1"># Save the DataFrame to a CSV file
</span><span class="n">df</span><span class="p">.</span><span class="nf">to_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">output.csv</span><span class="sh">'</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div>

<p>which looks like this,</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># output.csv
</span><span class="n">timestamp_ms</span><span class="p">,</span><span class="n">distance</span><span class="p">,</span><span class="n">left_pwm</span><span class="p">,</span><span class="n">right_pwm</span>
<span class="mi">2</span><span class="p">,</span><span class="mi">1757</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">147</span>
<span class="mi">17</span><span class="p">,</span><span class="mi">1761</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">147</span>
<span class="mi">28</span><span class="p">,</span><span class="mi">1761</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">147</span>
<span class="mi">44</span><span class="p">,</span><span class="mi">1788</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">147</span>
<span class="mi">61</span><span class="p">,</span><span class="mi">1772</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">147</span>
<span class="mi">72</span><span class="p">,</span><span class="mi">1772</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">147</span>
<span class="mi">88</span><span class="p">,</span><span class="mi">1772</span><span class="p">,</span><span class="mi">213</span><span class="p">,</span><span class="mi">147</span>
<span class="p">...</span><span class="bp">...</span>
</code></pre></div></div>

<p>Video of the car running at full speed toward wall:</p>

<iframe width="1634" height="683" src="https://www.youtube.com/embed/yMFCCUuQPRI" title="Fast robot lab7: run towards the wall" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>

<h2 id="2-initialize-kf-python">2. Initialize KF (Python)</h2>

<blockquote>
  <p>Compute the A and B matrix given the terms you found above, and discretize your matrices. Be sure to note the sampling time in your write-up.</p>

</blockquote>

\[d = \frac{u}{\dot{x}}
 = \frac{1}{2.5 \space mm/ms} = 0.4\]

\[m = \frac{-d \times t_{0.9}}{\ln(1-0.9)} = \frac{-0.4 \times 1080}{-2.3} = 187.8\]

<p>Now we have the estimation of parameter $d$ and $m$, we can calculate the matrix $A$ abd $B$。</p>

\[A =
\begin{bmatrix}
0 &amp; 1 \\
0 &amp; -\frac{d}{m} 
\end{bmatrix} 

= \begin{bmatrix}
0 &amp; 1 \\
0 &amp; -0.00213 \\
\end{bmatrix}\]

\[B = \begin{bmatrix}
0 \\
\frac{1}{m} \\ 
\end{bmatrix} 
= 
\begin{bmatrix}
0 \\
\frac{1}{187.8} \\
\end{bmatrix} 
=
\begin{bmatrix}
0 \\
0.0053 \\ 
\end{bmatrix}\]

<p>Using the following code, I find the average sampling time interval is 8.10 ms,</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">interval_sum</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">):</span>
    <span class="n">interval_sum</span> <span class="o">+=</span> <span class="n">timestamps_ms</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">timestamps_ms</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">interval</span> <span class="o">=</span> <span class="n">interval_sum</span> <span class="o">/</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></div>

<p>So $\Delta t$ is set to 8.1ms</p>

<p>Descretize the matrices:
\(Ad = I + \Delta t \times A \\
Bd = \Delta t \times B\)</p>

<blockquote>
  <p>Identify your C matrix. Recall that C is a m x n matrix, where n are the dimensions in your state space, and m are the number of states you actually measure.</p>
</blockquote>

\[C = \begin{bmatrix}
-1 &amp; 0
\end{bmatrix}\]

<blockquote>
  <p>Initialize your state vector</p>
</blockquote>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="o">-</span><span class="n">distance</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">]])</span>
</code></pre></div></div>

<blockquote>
  <p>For the Kalman Filter to work well, you will need to specify your process noise and sensor noise covariance matrices.</p>
</blockquote>

\[\Sigma_u =

\begin{bmatrix}
\sigma_1^2 &amp; 0 \\
0 &amp; \sigma_2^2 \\
\end{bmatrix}\]

<p>Position stddev after 1s: $\sqrt{10^2 · \frac{1}{0.008}} = 111.8 \space mm$</p>

<p>Speed stddev after 1s: $\sqrt{10^2 · \frac{1}{0.008}} = 111.8 \space mm/s$
\(\sigma_3^2 = (20 mm)^2\)</p>

<h2 id="3-implement-and-test-your-kalman-filter-in-jupyter-python">3. Implement and test your Kalman Filter in Jupyter (Python)</h2>

<p>Parameter settings are as follows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">d</span> <span class="o">=</span> <span class="mf">0.4</span>
<span class="n">m</span> <span class="o">=</span> <span class="mf">187.8</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">d</span><span class="o">/</span><span class="n">m</span><span class="p">]])</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">m</span><span class="p">]])</span>
<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>

<span class="n">sig1</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">sig2</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">sig3</span> <span class="o">=</span> <span class="mi">20</span>

<span class="n">Sig_u</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="n">sig1</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">sig2</span><span class="o">**</span><span class="mi">2</span><span class="p">]])</span>
<span class="n">Sig_z</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="n">sig3</span><span class="o">**</span><span class="mi">2</span><span class="p">]])</span>

<span class="n">delta_t</span> <span class="o">=</span> <span class="mf">8.1</span>

<span class="n">Ad</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">delta_t</span> <span class="o">*</span> <span class="n">A</span>
<span class="n">Bd</span> <span class="o">=</span> <span class="n">delta_t</span> <span class="o">*</span> <span class="n">B</span>
</code></pre></div></div>

<p>Kalman Filter process:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">kf</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    
    <span class="n">mu_p</span> <span class="o">=</span> <span class="n">Ad</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">+</span> <span class="n">Bd</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> 
    <span class="n">sigma_p</span> <span class="o">=</span> <span class="n">Ad</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">sigma</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">Ad</span><span class="p">.</span><span class="nf">transpose</span><span class="p">()))</span> <span class="o">+</span> <span class="n">Sig_u</span>
    
    <span class="n">sigma_m</span> <span class="o">=</span> <span class="n">C</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">sigma_p</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="nf">transpose</span><span class="p">()))</span> <span class="o">+</span> <span class="n">Sig_z</span>
    <span class="n">kkf_gain</span> <span class="o">=</span> <span class="n">sigma_p</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">C</span><span class="p">.</span><span class="nf">transpose</span><span class="p">().</span><span class="nf">dot</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="nf">inv</span><span class="p">(</span><span class="n">sigma_m</span><span class="p">)))</span>

    <span class="n">y_m</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">C</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">mu_p</span><span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">mu_p</span> <span class="o">+</span> <span class="n">kkf_gain</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">y_m</span><span class="p">)</span>    
    <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">kkf_gain</span><span class="p">.</span><span class="nf">dot</span><span class="p">(</span><span class="n">C</span><span class="p">)).</span><span class="nf">dot</span><span class="p">(</span><span class="n">sigma_p</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span>

<span class="c1"># init position state
</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="o">-</span><span class="n">distances</span><span class="p">[</span><span class="mi">0</span><span class="p">]],[</span><span class="mi">0</span><span class="p">]])</span>
<span class="c1"># init guess of uncertainty
</span><span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([[</span><span class="mi">5</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="o">**</span><span class="mi">2</span><span class="p">]])</span>

<span class="n">kf_state</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">left_pwms</span><span class="p">,</span> <span class="n">distances</span><span class="p">):</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">sig</span> <span class="o">=</span> <span class="nf">kf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="p">[[</span><span class="n">u</span> <span class="o">/</span> <span class="mi">210</span><span class="p">]],</span> <span class="p">[[</span><span class="o">-</span><span class="n">d</span><span class="p">]])</span>
    <span class="n">kf_state</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</code></pre></div></div>

<p>Raw sensor reading value and kalman filter estimation:</p>

<p><img src="/FastRobots/images/Lab7/kalman-filter.png" alt="kalman-filter" style="zoom:40%;" /></p>

<p>The larger <code class="language-plaintext highlighter-rouge">sig_1</code> and <code class="language-plaintext highlighter-rouge">sig_2</code> are, the less we trust the robot model, the larger <code class="language-plaintext highlighter-rouge">sig_3</code> is, the less we trust the sensor reading. By adjusting the deviation value, we can find an appropriate way to combine the information of both snesor reading and model processing.</p>

<p>The prediction matches the sensor reading better as the standard deviation that I calculated for the robot model is large.</p>

  </div><a class="u-url" href="/FastRobots/jekyll/update/2024/04/14/Lab7.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/FastRobots/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Fast Robots 2024 Spring</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Fast Robots 2024 Spring</li><li><a class="u-email" href="mailto:dy297@cornell.edu">dy297@cornell.edu</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/yang-d19"><svg class="svg-icon"><use xlink:href="/FastRobots/assets/minima-social-icons.svg#github"></use></svg> <span class="username">yang-d19</span></a></li><li><a href="https://www.linkedin.com/in/ding-yang-829248219"><svg class="svg-icon"><use xlink:href="/FastRobots/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">ding-yang-829248219</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This website displays the content in the course Fast Robots (Cornell ECE 5160 Spring 2024).</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
