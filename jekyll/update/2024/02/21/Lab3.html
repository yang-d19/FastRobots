<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Lab3 | Fast Robots 2024 Spring</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Lab3" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Prelab" />
<meta property="og:description" content="Prelab" />
<link rel="canonical" href="http://localhost:4000/FastRobots/jekyll/update/2024/02/21/Lab3.html" />
<meta property="og:url" content="http://localhost:4000/FastRobots/jekyll/update/2024/02/21/Lab3.html" />
<meta property="og:site_name" content="Fast Robots 2024 Spring" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-02-21T00:00:00-05:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Lab3" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-02-21T00:00:00-05:00","datePublished":"2024-02-21T00:00:00-05:00","description":"Prelab","headline":"Lab3","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/FastRobots/jekyll/update/2024/02/21/Lab3.html"},"url":"http://localhost:4000/FastRobots/jekyll/update/2024/02/21/Lab3.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/FastRobots/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/FastRobots/feed.xml" title="Fast Robots 2024 Spring" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/FastRobots/">Fast Robots 2024 Spring</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/FastRobots/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Lab3</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2024-02-21T00:00:00-05:00" itemprop="datePublished">Feb 21, 2024
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="prelab">Prelab</h2>

<h3 id="1-note-the-i2c-sensor-address">1. Note the I2C sensor address</h3>

<p><img src="/FastRobots/images/Lab3/i2c addr of ToF sensor.png" alt="i2c addr of ToF sensor" style="zoom: 33%;" /></p>

<p>From the datasheet of VL53L1X Distance Sensor, we can read that the I2C sensor address if <strong>0x29</strong>.</p>

<h3 id="2-briefly-discuss-the-approach-to-using-2-tof-sensors">2. <strong>Briefly</strong> discuss the approach to using 2 ToF sensors</h3>

<p>Although the lab guide suggests using <code class="language-plaintext highlighter-rouge">SparkFun VL53L1X 4m Laser Distance Sensor</code> library, it doesnot have a clear and direct example that shows how to use more than 1 ToF sensors simaltaneously. So I choose to use the <code class="language-plaintext highlighter-rouge">VL53L1X</code> developed by Pololu.</p>

<p><img src="/FastRobots/images/Lab3/vl53l1x.png" alt="vl53l1x" style="zoom:50%;" /></p>

<p>Load the <code class="language-plaintext highlighter-rouge">ContinuousMultipleSensors.ino</code> file from its Examples. It provide the sketch of using mulitple ToF sensors. I do the following job to make it compatible with my own robot.</p>

<h4 id="1-solder-two-seperate-wires-to-their-shutdown-pins">(1) Solder two seperate wires to their shutdown pins</h4>

<p><img src="/FastRobots/images/Lab3/shutdown pin wires.jpg" alt="shutdown pin wires" style="zoom: 20%;" /></p>

<ul>
  <li>Green wire connects pin 15 and the XSHUT of front ToF sensor</li>
  <li>Yellow wire connects pin 16 and the XSHUT of side ToF sensor</li>
</ul>

<h4 id="2-configure-shutdown-pins-number-and-reset-their-address">(2) Configure shutdown pins number and reset their address</h4>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">xshutPins</span><span class="p">[</span><span class="n">sensorCount</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span> <span class="p">};</span>

<span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sensorCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// Stop driving this sensor's XSHUT low. This should allow the carrier</span>
  <span class="c1">// board to pull it high. (We do NOT want to drive XSHUT high since it is</span>
  <span class="c1">// not level shifted.) Then wait a bit for the sensor to start up.</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">xshutPins</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">INPUT</span><span class="p">);</span>
  <span class="p">......</span>
    
  <span class="c1">// reset sensor I2C address</span>
  <span class="n">sensors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setAddress</span><span class="p">(</span><span class="mh">0x2A</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
  <span class="p">......</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="3-briefly-discuss-placement-of-sensors-on-robot-and-scenarios-where-you-will-miss-obstacles">3. <strong>Briefly</strong> discuss placement of sensors on robot and scenarios where you will miss obstacles</h3>

<p>One installed on the front of the robot and the other on the right side of the robot.</p>

<p>Scenarios that may miss obstables:</p>

<ul>
  <li>The obstacles are on the left or on the back of the robot</li>
  <li>The obstacles are too high or too low</li>
</ul>

<h3 id="4-sketch-of-wiring-diagram">4. Sketch of wiring diagram</h3>

<p><img src="/FastRobots/images/Lab3/2tof.jpg" alt="2tof" style="zoom: 33%;" /></p>

<h2 id="lab-tasks">Lab Tasks</h2>

<h3 id="1-picture-of-your-tof-sensor-connected-to-your-qwiic-breakout-board">1. Picture of your ToF sensor connected to your QWIIC breakout board</h3>

<p><img src="/FastRobots/images/Lab3/breaout board.jpg" alt="breaout board" style="zoom:25%;" /></p>

<h3 id="2-screenshot-of-artemis-scanning-for-i2c-device-and-discussion-on-i2c-address">2. Screenshot of Artemis scanning for I2C device (and discussion on I2C address)</h3>

<p>I add the following code to display the process of scanning for I2C devices:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="p">(</span><span class="kt">uint8_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sensorCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">......</span>

  <span class="kt">uint8_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">sensors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">getAddress</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">"Detected sensor %d with address %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
  <span class="p">......</span>

  <span class="c1">// Each sensor must have its address changed to a unique value other than</span>
  <span class="c1">// the default of 0x29 (except for the last one, which could be left at</span>
  <span class="c1">// the default). To make it simple, we'll just count up from 0x2A.</span>
  <span class="n">sensors</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">setAddress</span><span class="p">(</span><span class="mh">0x2A</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

  <span class="n">Serial</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s">"Set new address %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="mh">0x2A</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The screenshot:</p>

<p><img src="/FastRobots/images/Lab3/scan i2c devices.png" alt="scan i2c devices" style="zoom:45%;" /></p>

<p>41 in decimal is 0x29 in hexadecimal, which is same as the initial i2c address.</p>

<p>The newly set address is 42 and 43, which correspond to 0x2A and 0x2B.</p>

<p>Now the 2 ToF sensors have two different I2C address, so they can all be read on the same time.</p>

<h3 id="3-discussion-and-pictures-of-sensor-data-with-chosen-mode">3. Discussion and pictures of sensor data with chosen mode</h3>

<p>From 100mm to 1000mm, I sampled 20 data points at each position with three diffrent modes, and plot them on the graph.</p>

<p><img src="/FastRobots/images/Lab3/3modes-compare.png" alt="3modes-compare" style="zoom:33%;" /></p>

<p>The short mode has least standard deviation. The deviation of sample datapoints at each position of short mode is plotted below:</p>

<p><img src="/FastRobots/images/Lab3/std_dev.png" alt="std_dev" style="zoom: 33%;" /></p>

<p>It can be seen from the plot that when the distance is larger than 1.3m, the standard deviation of the data points has a large leap. So if we choose Short Mode, we’d better keep the obstacles within 1.3m of the ToF sensor.</p>

<h3 id="4-2-tof-sensors-discussion-and-screenshot-of-sensors-working-in-parallel">4. 2 ToF sensors: Discussion and screenshot of sensors working in parallel</h3>

<p>Two ToF sensors are connected through Qwiic connect system to the Artemis board, with the help of a multiport board. However, the default address of I2C address are the same for two ToF sensors, so we need to modify the hardware to support two sensors working in parellel.</p>

<p>The first thing I do is solder two seperate wires to each of the sensor’s XSHUT pin. And they are all pulled LOW in order to disable the sensors. Then one by one, stop driving the XSHUT pin LOW, which will enable a certain sensor. After that, setting the Distance Mode of current sensor and assign a new address to it, so that later we can directly call the sensors without manipulating the XSHUT pins.</p>

<p>Now all the sensors can work in the same time. Below is the screenshot:</p>

<p><img src="/FastRobots/images/Lab3/paralell.png" alt="paralell" style="zoom: 40%;" /></p>

<h3 id="5-tof-sensor-speed-discussion-on-speed-and-limiting-factor-include-code-snippet-of-how-you-do-this">5. Tof sensor speed: Discussion on speed and limiting factor; include code snippet of how you do this</h3>

<p>I record the distance data to an array without blocking the main loop of the program,</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Record</span> <span class="n">records</span><span class="p">[</span><span class="n">MAX_RECORDS_LEN</span><span class="p">];</span>

<span class="kt">uint16_t</span> <span class="n">record_ptr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">saveCurrRecordToArray</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ControllerRecord</span> <span class="n">ctrl_record</span> <span class="o">=</span> <span class="n">getCtrlRecord</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">record_ptr</span> <span class="o">&lt;</span> <span class="n">MAX_RECORDS_LEN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">records</span><span class="p">[</span><span class="n">record_ptr</span><span class="p">].</span><span class="n">timestamp_ms</span> <span class="o">=</span> <span class="n">elapsed_ms</span><span class="p">;</span>
        <span class="n">records</span><span class="p">[</span><span class="n">record_ptr</span><span class="p">].</span><span class="n">distance</span> <span class="o">=</span> <span class="n">distance</span><span class="p">;</span>
        <span class="n">record_ptr</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
		<span class="p">......</span>
    <span class="c1">// While central is connected</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">central</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
          <span class="p">......</span>
          <span class="n">curr_ms</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
          <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="n">curr_ms</span> <span class="o">-</span> <span class="n">start_ms</span><span class="p">;</span>

          <span class="n">distance</span> <span class="o">=</span> <span class="n">readDistance</span><span class="p">();</span> 
          <span class="n">saveCurrRecordToArray</span><span class="p">();</span>
          <span class="p">......</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And send the recored data to laptop over bluetooth:</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">handleCommand</span><span class="p">()</span> <span class="p">{</span>
  	<span class="p">......</span>
  	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_type</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">......</span>
        <span class="k">case</span> <span class="n">GET_HISTORY_DATA</span><span class="p">:</span> <span class="p">{</span>
          
            <span class="k">const</span> <span class="n">Record</span> <span class="o">*</span><span class="n">records</span><span class="p">;</span>
            <span class="kt">uint16_t</span> <span class="n">records_size</span> <span class="o">=</span> <span class="n">getHistoryRecords</span><span class="p">(</span><span class="o">&amp;</span><span class="n">records</span><span class="p">);</span>

            <span class="n">tx_estring_value</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
            <span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="s">"Size of records array: "</span><span class="p">);</span>
            <span class="n">tx_estring_value</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">records_size</span><span class="p">);</span>
            <span class="n">tx_characteristic_string</span><span class="p">.</span><span class="n">writeValue</span><span class="p">(</span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>

            <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">records_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">putARecordToTxEstring</span><span class="p">(</span><span class="n">records</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
                <span class="n">tx_characteristic_string</span><span class="p">.</span><span class="n">writeValue</span><span class="p">(</span><span class="n">tx_estring_value</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">......</span>
		<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When the Distance Mode changes or the parameter inside <code class="language-plaintext highlighter-rouge">sensors[i].startContinuous(period_ms);</code> changes, the average of sensor reading intervals are subject to change. I tested several groups of data and list them in the tables below.</p>

<table>
  <thead>
    <tr>
      <th>Distance Mode: Long</th>
      <th>startContinuous(50)</th>
      <th>startContinuous(100)</th>
      <th>startContinuous(200)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Average Interval (ms):</td>
      <td>92</td>
      <td>92</td>
      <td>186</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th>Distance Mode: Medium</th>
      <th>startContinuous(33)</th>
      <th>startContinuous(100)</th>
      <th>startContinuous(200)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Average Interval (ms):</td>
      <td>61</td>
      <td>92</td>
      <td>185</td>
    </tr>
  </tbody>
</table>

<table>
  <thead>
    <tr>
      <th>Distance Mode: Short</th>
      <th>startContinuous(20)</th>
      <th>startContinuous(100)</th>
      <th>startContinuous(200)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Average Interval (ms):</td>
      <td>37</td>
      <td>92</td>
      <td>185</td>
    </tr>
  </tbody>
</table>

<p>We can conclude that there are 3 factors that limit ToF sensor speed:</p>

<ul>
  <li><strong>Frequency of the main loop</strong>: If their are too many code in the main loop, or some code block the running of the main loop function, the reading of ToF sensors will be delayed.</li>
  <li><strong>Parameter in the sensor.startContinuous()</strong>: The smaller the parameter is, the faster the sensor reads, but there is a lower bound affected by distance mode.</li>
  <li><strong>Tof sensor speed</strong>: When set to Short, sensor has the highest possible reading speed, when set to Long, sensor has the lowest possible reading speed.</li>
</ul>

<p>The minimal sensor reading interval is 37ms, which is 27Hz.</p>

<h3 id="6-time-v-distance-include-graph-of-data-sent-over-bluetooth-2-sensors">6. Time v Distance: Include graph of data sent over bluetooth (2 sensors)</h3>

<p><img src="/FastRobots/images/Lab3/2-distance.png" alt="2-distance" style="zoom:50%;" /></p>

<h3 id="7-5000-discussion-on-infrared-transmission-based-sensors">7. (5000) Discussion on infrared transmission based sensors</h3>

<p>Infrared (IR) distance sensors are a popular choice for many applications due to their non-contact nature, which makes them ideal for measuring distances without physically touching the object.</p>

<p>There are different types of IR based sensors:</p>

<ol>
  <li><strong>Infrared Time-of-Flight (ToF) Sensors</strong>
    <ul>
      <li>Pros: High accuracy and precision; Immune to ambient light; Good range</li>
      <li>Cons: High Cost; Sensitive to materials</li>
    </ul>
  </li>
  <li><strong>Infrared Reflective Sensors</strong>
    <ul>
      <li>Pros: Cost-effective; Easy to integrate and use</li>
      <li>Cons: Limited range; Sensitive to ambient light</li>
    </ul>
  </li>
  <li><strong>Infrared Array Sensors</strong>
    <ul>
      <li>Pros: Spatial awareness</li>
      <li>Cons: High complexity and cost</li>
    </ul>
  </li>
</ol>

<h3 id="8-5000-sensitivity-of-sensors-to-colors-and-textures">8. (5000) Sensitivity of sensors to colors and textures</h3>

<h4 id="principle-analysis">Principle Analysis</h4>

<p>The design of the infrared depth sensor is based on the principle of Time of Flight (TOF), that is, the sensor emits the modulated near-infrared light, which is reflected after the object, and the sensor calculates the distance from the object by calculating the time difference or phase difference between the emission and reflection of the light.</p>

<p><img src="/FastRobots/images/Lab3/tof-1.png" alt="tof-1" style="zoom: 33%;" /></p>

<p>Because the light is infrared, not in the spectrum of visable light, the color of the reflection plane will not have a direct impact on the IR sensor.</p>

<p>But if the plane is too smooth that it causes speccular reflection instead of diffuse reflection, it is very likely that the receivers will not detect any light from the smooth surface.</p>

<p><img src="/FastRobots/images/Lab3/tof-2.png" alt="tof-2" style="zoom:50%;" /></p>

<h4 id="colors">Colors</h4>

<p>I tried 3 different colors: orange, blue and green. Below is the comparison:</p>

<p><img src="/FastRobots/images/Lab3/colors.png" alt="colors" style="zoom:50%;" /></p>

<p>We can see that the colors have little influence on the accuracy of the ToF sensors.</p>

<h4 id="textures">Textures</h4>

<p>I tried 3 different textures: white wall, glass (the screen of my iPad) and metal (the back panel of my iPad), and below is the distance sensor reading:</p>

<p><img src="/FastRobots/images/Lab3/textures.png" alt="textures" style="zoom:50%;" /></p>

<p>On the conditions of wall and metal, the ToF sensor works normally. Howver, when the reflection plane is glass, the accuracy of the ToF sensors drops sharply, which means the data of ToF sensor have large standard deviation, adding uncertainty to the data.</p>

  </div><a class="u-url" href="/FastRobots/jekyll/update/2024/02/21/Lab3.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/FastRobots/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Fast Robots 2024 Spring</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Fast Robots 2024 Spring</li><li><a class="u-email" href="mailto:dy297@cornell.edu">dy297@cornell.edu</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/yang-d19"><svg class="svg-icon"><use xlink:href="/FastRobots/assets/minima-social-icons.svg#github"></use></svg> <span class="username">yang-d19</span></a></li><li><a href="https://www.linkedin.com/in/ding-yang-829248219"><svg class="svg-icon"><use xlink:href="/FastRobots/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">ding-yang-829248219</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>This website displays the content in the course Fast Robots (Cornell ECE 5160 Spring 2024).</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
